CREATE OR REPLACE TABLE CUSTOMER
(C_CUSTKEY	int
,C_NAME	varchar
,C_ADDRESS	varchar
,C_NATIONKEY	int
,C_PHONE	varchar
,C_ACCTBAL	varchar
,C_MKTSEGMENT	varchar
,C_COMMENT	varchar
,N_NAME	varchar
,Load_date	Date
);


Create or Replace file format CSVTYPE
TYPE='CSV'
SKIP_HEADER=1
FIELD_DELIMITER=','
RECORD_DELIMITER='\n'
FIELD_OPTIONALLY_ENCLOSED_BY ='"'
DATE_FORMAT='DD-MM-YYYY'
COMPRESSION = NONE;




CREATE OR REPLACE STORAGE INTEGRATION AWS_INT
TYPE = EXTERNAL_STAGE
ENABLED=TRUE
STORAGE_PROVIDER = 'S3'
STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::311410995815:role/Anil_s3_full_acess'
STORAGE_ALLOWED_LOCATIONS =('s3://awstosnowflake1995/');

ALTER STORAGE INTEGRATION AWS_INT
SET STORAGE_ALLOWED_LOCATIONS = (
  's3://awstosnowflake1995/',
  's3://e-commerce-project-id-01/'
);



DESC INTEGRATION AWS_INT;







CREATE OR REPLACE STAGE SOURCE_AWS_STAGE
FILE_FORMAT='CSVTYPE'
STORAGE_INTEGRATION=AWS_INT
URL='s3://awstosnowflake1995/landing/';


LIST @SOURCE_AWS_STAGE;


Select $1,$2,$3 from @SOURCE_AWS_STAGE limit 10;



Select * from customer;


COPY INTO CUSTOMER 
FROM @SOURCE_AWS_STAGE;

COPY INTO CUSTOMER 
FROM @SOURCE_AWS_STAGE
VALIDATION_MODE=RETURN_ALL_ERRORS;



COPY INTO CUSTOMER 
FROM @SOURCE_AWS_STAGE
ON_ERROR=CONTINUE;


Select * from CUSTOMER;



---destination stage

CREATE OR REPLACE STAGE DESTINATION_AWS_STAGE
FILE_FORMAT='CSVTYPE'
STORAGE_INTEGRATION=AWS_INT
URL='s3://awstosnowflake1995/destination/';



LIST @SOURCE_AWS_STAGE;



---Copy files from landing folder to desitnation folder 


COPY FILES INTO @DESTINATION_AWS_STAGE
FROM @SOURCE_AWS_STAGE;





REMOVE @DESTINATION_AWS_STAGE;

LISt @DESTINATION_AWS_STAGE;


CREATE OR REPLACE TABLE FAULTY_RECORD AS 
SELECT * FROM TABLE(VALIDATE(CUSTOMER, JOB_ID=>'_last'));


Select * from FAULTY_RECORD;


COPY INTO @DESTINATION_AWS_STAGE
FROM FAULTY_RECORD;

REMOVE @DESTINATION_AWS_STAGE;

COPY INTO @DESTINATION_AWS_STAGE/vijayrecords.csv
FROM FAULTY_RECORD
INCLUDE_QUERY_ID = TRUE;


select * from Brazil_Customer
limit 10

